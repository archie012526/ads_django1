{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ADS Project{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .input-field {
            width: 100%;
            margin-top: 0.25rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            outline: none;
        }
        .input-field:focus {
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgb(168 85 247 / 0.3);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        body.dark-mode .header {
            background-color: #2d3748;
            border-bottom: 1px solid #4a5568;
        }
        body.dark-mode .search-bar {
            background-color: #374151;
            border-color: #4b5563;
        }
        body.dark-mode .search-input {
            background-color: #374151;
            color: #e2e8f0;
        }
        body.dark-mode .nav-item {
            color: #cbd5e0;
        }
        body.dark-mode .nav-item:hover,
        body.dark-mode .nav-active {
            color: #ffffff;
        }
        body.dark-mode .profile-card,
        body.dark-mode .create-post-card,
        body.dark-mode .post-card,
        body.dark-mode .job-card,
        body.dark-mode .recommended-card,
        body.dark-mode .bg-white {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
        }
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select {
            background-color: #374151;
            color: #e2e8f0;
            border-color: #4b5563;
        }
        body.dark-mode .text-gray-900,
        body.dark-mode .text-gray-800,
        body.dark-mode .text-gray-700 {
            color: #e2e8f0 !important;
        }
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-500 {
            color: #cbd5e0 !important;
        }
        body.dark-mode .settings-container {
            background-color: #1a202c;
        }
        body.dark-mode .settings-nav,
        body.dark-mode .settings-content {
            background-color: #2d3748;
            border-color: #4a5568;
        }
    </style>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'style/base.css' %}?v=7">
    <link rel="stylesheet" href="{% static 'style/styles.css' %}">
    <link rel="stylesheet" href="{% static 'style/landing.css' %}">

    {% block extra_head %}{% endblock %}
</head>

<body {% if user.is_authenticated and user.profile.dark_mode %}class="dark-mode"{% endif %}>

        <!-- Logo -->
    <header class="header">
        <div class="left-side">
            <div class="logo-circle">
                <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
            </div>

        <!-- ‚úÖ SEARCH BAR (NOW FUNCTIONAL) -->
        <form method="get" action="{% url 'search' %}" class="search-bar flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="7" stroke-width="2"/>
                <path d="M16 16l4 4" stroke-width="2"/>
            </svg>

            <input
                type="text"
                name="q"
                placeholder="Search jobs, people, employers..."
                value="{{ request.GET.q }}"
                class="search-input"
            >
        </form>

    </div>

    <!-- CENTER NAV -->
    <nav class="nav-center">

        <a href="{% url 'homepage' %}"
           class="nav-item nav-link flex items-center gap-1 {% if request.path == '/' %}nav-active{% endif %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M3 10.5L12 4l9 6.5V21H3V10.5z" stroke-width="2"/>
            </svg>
            <span>Home</span>
        </a>

        <a href="{% url 'find_job' %}"
           class="nav-item nav-link flex items-center gap-1 {% if request.path == '/find-job/' %}nav-active{% endif %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M3 7h18v13H3V7zm6-4h6v4H9V3z" stroke-width="2"/>
            </svg>
            <span>Find Jobs</span>
        </a>

        <a href="{% url 'messages' %}"
           class="nav-item nav-link flex items-center gap-1 {% if request.path == '/messages/' %}nav-active{% endif %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M4 5h16v10H7l-3 3V5z" stroke-width="2"/>
            </svg>
            <span>Messages</span>
        </a>

        <a href="{% url 'notifications' %}"
           class="nav-item nav-link flex items-center gap-1 {% if request.path == '/notifications/' %}nav-active{% endif %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 2a6 6 0 0 1 6 6v4l2 3H4l2-3V8a6 6 0 0 1 6-6zm0 19a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2z" stroke-width="2"/>
            </svg>
            <span>Notifications</span>
        </a>

        <a href="{% url 'profile' %}"
           class="nav-item nav-link flex items-center gap-1 {% if request.path == '/profile/' %}nav-active{% endif %}">
            <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="7" r="4" stroke-width="2"/>
                <path d="M4 21c0-4 4-7 8-7s8 3 8 7" stroke-width="2"/>
            </svg>
            <span>Me</span>
        </a>

    </nav>

    
</header>

<!-- MAIN CONTENT -->
{% block content %}{% endblock %}

</body>
<script>
document.getElementById("themeToggle")?.addEventListener("change", function () {
    document.body.classList.toggle("dark-theme", this.checked);
});

// Real-time WebSocket connection for notifications
{% if user.is_authenticated %}
(function() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + window.location.host + '/ws/notifications/';
    
    let notificationSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    function connectWebSocket() {
        notificationSocket = new WebSocket(wsUrl);
        
        notificationSocket.onopen = function(e) {
            console.log('‚úÖ WebSocket connected for real-time notifications');
            reconnectAttempts = 0;
        };
        
        notificationSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'notification') {
                handleNotification(data.notification);
            } else if (data.type === 'global_notification') {
                handleGlobalNotification(data.notification);
            }
        };
        
        notificationSocket.onclose = function(e) {
            console.log('‚ùå WebSocket disconnected');
            
            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`‚è≥ Reconnecting in ${delay/1000}s... (Attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(connectWebSocket, delay);
            }
        };
        
        notificationSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }
    
    function handleNotification(notification) {
        console.log('üîî New notification:', notification);
        
        // Show browser notification if permission granted
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(notification.title, {
                body: notification.message,
                icon: '/static/media/logo.png'
            });
        }
        
        // Update notification badge count
        const badge = document.querySelector('.notification-badge');
        if (badge) {
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
            badge.style.display = 'flex';
        }
        
        // Optionally reload notifications if on notifications page
        if (window.location.pathname === '/notifications/') {
            setTimeout(() => location.reload(), 2000);
        }
    }
    
    function handleGlobalNotification(notification) {
        console.log('üì¢ New global notification:', notification);
        // Global notifications are received but not displayed
    }
    
    function createGlobalNotificationElement(notification) {
        const div = document.createElement('div');
        div.className = `global-notification global-notification-${notification.level}`;
        div.style.opacity = '0';
        div.style.transition = 'opacity 0.3s ease';
        
        div.innerHTML = `
            <div class="global-notification-content">
                <div class="global-notification-icon">
                    ${getIconSvg(notification.level)}
                </div>
                <div class="global-notification-text">
                    <strong>${notification.title}</strong>
                    <span>${notification.message}</span>
                </div>
            </div>
            <button onclick="this.parentElement.remove()" class="global-notification-close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        return div;
    }
    
    function getIconSvg(level) {
        const icons = {
            info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4M12 8h.01"></path></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><path d="M12 9v4M12 17h.01"></path></svg>',
            danger: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M15 9l-6 6M9 9l6 6"></path></svg>'
        };
        return icons[level] || icons.info;
    }
    
    function showToast(title, message, level) {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: ${level === 'danger' ? '#E74C3C' : level === 'warning' ? '#F5A623' : '#4A90E2'};
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            max-width: 350px;
            animation: slideInRight 0.3s ease;
        `;
        
        toast.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
            <div style="font-size: 14px; opacity: 0.95;">${message}</div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Connect on page load
    connectWebSocket();
    
    // Reconnect on window focus (if connection lost)
    window.addEventListener('focus', function() {
        if (!notificationSocket || notificationSocket.readyState === WebSocket.CLOSED) {
            console.log('üîÑ Reconnecting WebSocket on window focus...');
            connectWebSocket();
        }
    });
})();
{% endif %}

// Add CSS animation for toast
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>

</html>


{% extends "main/base.html" %}
{% load static %}

{% block extra_head %}
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style/profile.css' %}?v=3">
{% endblock extra_head %}

{% block content %}
<div class="profile-shell">
    <div class="profile-hero">
        <div class="hero-left">
            {% if profile.profile_image %}
                <img src="{{ profile.profile_image.url }}" class="profile-avatar" alt="Profile image">
            {% else %}
                <div class="profile-avatar placeholder"></div>
            {% endif %}
            <div>
                <p class="eyebrow">Profile</p>
                <h1 class="hero-title">{{ profile.full_name|default:user.username }}</h1>
                <p class="hero-bio">{{ profile.bio|default:"Add a short bio to help people know you." }}</p>
                <div class="hero-meta">
                    {% if profile.location %}<span class="meta-pill">üìç {{ profile.location }}</span>{% endif %}
                    {% if profile.role %}<span class="meta-pill">{{ profile.role|title }}</span>{% endif %}
                </div>
                <div class="hero-actions">
                    <a href="{% url 'edit_profile' %}" class="primary-cta">Edit profile</a>
                    <a href="{% url 'job_applications' %}" class="ghost-btn">View applications</a>
                </div>
            </div>
        </div>
        <div class="hero-stats">
            <div class="stat-chip">
                <span class="stat-label">Applications</span>
                <span class="stat-value">{{ applications_count }}</span>
            </div>
            <div class="stat-chip">
                <span class="stat-label">Interviews</span>
                <span class="stat-value">{{ interviews_count }}</span>
            </div>
            <div class="stat-chip">
                <span class="stat-label">Skills</span>
                <span class="stat-value">{{ profile.skills.all|length }}</span>
            </div>
            <div class="stat-chip">
                <span class="stat-label">Matches</span>
                <span class="stat-value">{{ suggestions|length }}</span>
            </div>
        </div>
    </div>

    <div class="profile-grid">
        <div class="profile-main">
            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">Skills</p>
                        <h2 class="card-title">Skills & Competencies</h2>
                    </div>
                    <a href="{% url 'edit_profile' %}" class="ghost-btn small">Add skills</a>
                </div>
                {% if profile.skills.exists %}
                    <div class="chip-group">
                        {% for skill in profile.skills.all %}
                            <span class="skill-chip">{{ skill.name }}{% if skill.level %} ¬∑ {{ skill.level }}{% endif %}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="muted">No skills added yet.</p>
                {% endif %}
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">Opportunities</p>
                        <h2 class="card-title">Job Suggestions for You</h2>
                        <p class="muted">Matches based on your skills</p>
                    </div>
                </div>
                {% if suggestions %}
                    <div class="job-list">
                        {% for s in suggestions %}
                            {% with job=s.job %}
                            <div class="job-card">
                                <div class="job-info">
                                    <h3 class="job-title">{{ job.title }}</h3>
                                    <p class="job-company">{{ job.company_name|default:"Company not listed" }}</p>
                                    <p class="job-location">{{ job.location|default:"Remote" }}</p>
                                    <div class="job-badges">
                                        {% if job.employment_type %}<span class="pill">{{ job.get_employment_type_display }}</span>{% endif %}
                                        {% if job.working_schedule %}<span class="pill">{{ job.get_working_schedule_display }}</span>{% endif %}
                                        {% for tag in job.skills.all %}<span class="pill">{{ tag.name }}</span>{% endfor %}
                                    </div>
                                    <p class="job-description">{{ job.description|default:"No description provided."|truncatewords:35 }}</p>
                                </div>
                                <div class="job-meta">
                                    <span class="match-label">Skill match</span>
                                    <span class="match-value">{{ s.match_percent }}%</span>
                                </div>
                                <div class="job-actions">
                                    <a href="{% url 'apply_job' job.id %}" class="primary-cta">Apply now</a>
                                    <a href="{% url 'toggle_save_job' job.id %}" class="icon-btn" title="Save job">{% if job.saved_by.filter|length > 0 %}‚≠ê{% else %}‚òÜ{% endif %}</a>
                                </div>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="muted">No job suggestions yet. Add more skills to see tailored roles.</p>
                {% endif %}
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">Progress</p>
                        <h2 class="card-title">My Applications</h2>
                    </div>
                </div>
                {% if applications %}
                    <div class="job-list">
                        {% for app in applications %}
                            <div class="job-card">
                                <div class="job-info">
                                    <h3 class="job-title">{{ app.job.title }}</h3>
                                    <p class="job-company">{{ app.job.company_name|default:"Company not listed" }}</p>
                                    <p class="job-location">{{ app.job.location|default:"Remote" }}</p>
                                    <div class="job-badges">
                                        <span class="pill">{{ app.status }}</span>
                                        <span class="pill">Applied {{ app.applied_at|date:"M d, Y" }}</span>
                                    </div>
                                    {% if app.interview_scheduled_at %}
                                        <p class="job-description">Interview: {{ app.interview_scheduled_at|date:"M d, Y h:i A" }}{% if app.interview_location %} ‚Ä¢ {{ app.interview_location }}{% endif %}{% if app.interview_meeting_url %} ‚Ä¢ <a href="{{ app.interview_meeting_url }}" target="_blank">Join</a>{% endif %}</p>
                                    {% endif %}
                                </div>
                                <div class="job-actions">
                                    <a href="{% url 'download_interview_invite' app.id %}" class="ghost-btn">Download invite</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="muted">No applications yet.</p>
                {% endif %}
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">Pipeline</p>
                        <h2 class="card-title">My Interviews</h2>
                    </div>
                </div>
                {% if interviews %}
                    <div class="job-list">
                        {% for app in interviews %}
                            <div class="job-card">
                                <div class="job-info">
                                    <h3 class="job-title">{{ app.job.title }}</h3>
                                    <p class="job-company">{{ app.job.company_name|default:"Company not listed" }}</p>
                                    <p class="job-location">{{ app.job.location|default:"Remote" }}</p>
                                    <div class="job-badges">
                                        <span class="pill">Interview</span>
                                        <span class="pill">{{ app.interview_scheduled_at|date:"M d, Y h:i A" }}</span>
                                    </div>
                                    {% if app.interview_location or app.interview_meeting_url %}
                                        <p class="job-description">{% if app.interview_location %}Location: {{ app.interview_location }}{% endif %}{% if app.interview_meeting_url %} ‚Ä¢ <a href="{{ app.interview_meeting_url }}" target="_blank">Join</a>{% endif %}</p>
                                    {% endif %}
                                </div>
                                <div class="job-actions">
                                    <a href="{% url 'download_interview_invite' app.id %}" class="ghost-btn">Download invite</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="muted">No interviews yet.</p>
                {% endif %}
            </div>
        </div>

        <aside class="profile-aside">
            <div class="card">
                <p class="eyebrow">Quick Links</p>
                <div class="link-stack">
                    <a href="{% url 'edit_profile' %}">Update profile</a>
                    <a href="{% url 'add_location' %}">Add location</a>
                    <a href="{% url 'find_job' %}">Find jobs</a>
                    <a href="{% url 'job_applications' %}">View applications</a>
                    <a href="{% url 'interviews' %}">View interviews</a>
                </div>
            </div>

            {% if user_posts %}
            <div class="card">
                <p class="eyebrow">Recent posts</p>
                <div class="posts-list">
                    {% for post in user_posts|slice:":3" %}
                    <div class="post-item">
                        <div>
                            <p class="post-meta-line">{{ post.created_at|timesince }} ago</p>
                            {% if post.post_type == 'article' and post.article_title %}
                                <p class="post-title">{{ post.article_title }}</p>
                            {% else %}
                                <p class="post-title">{{ post.content|truncatewords:16 }}</p>
                            {% endif %}
                        </div>
                        <a href="{% url 'view_user_profile' user.id %}" class="post-link">View profile</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </aside>
    </div>
</div>
{% endblock content %}
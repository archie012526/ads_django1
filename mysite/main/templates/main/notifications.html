{% extends 'main/base.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'style/notifications.css' %}">

<div class="notif-container">


    <h1>Notifications</h1>
    <p class="subtitle">Stay updated with your latest activities and messages</p>

    <div class="notif-header">
        <input type="text" class="search-input" placeholder="Search notificationsâ€¦">
        
        <div class="controls">
            <button class="control-btn">Filter</button>
            <button class="control-btn">Type</button>
            <button class="control-btn">Analytics</button>
            <a href="{% url 'mark_all_as_read' %}" class="mark-read-btn">Mark All as Read</a>
        </div>
    </div>

    <div class="notif-list">
        {% for notif in notifications %}
        <div class="notif-item {% if not notif.is_read %}unread{% endif %}">
            <div class="notif-icon 
                {% if notif.notification_type == 'job_post' %}blue
                {% elif notif.notification_type == 'message' %}green
                {% elif notif.notification_type == 'job_application' %}orange
                {% else %}purple{% endif %}"></div>

            <div class="notif-content">
                <h3>{{ notif.title }}</h3>
                <p>{{ notif.message }}</p>
                {% if notif.link %}
                    <a href="{{ notif.link }}" style="color: #667eea; font-size: 13px; text-decoration: none; margin-top: 4px; display: inline-block;">View Details â†’</a>
                {% endif %}
            </div>

            <span class="notif-type">{{ notif.get_notification_type_display }}</span>
            <span class="notif-time">
                {{ notif.created_at|timesince }} ago
            </span>

            <span class="notif-status 
                {% if not notif.is_read %}unread-badge{% else %}read-badge{% endif %}">
                {% if not notif.is_read %}unread{% else %}read{% endif %}
            </span>
        </div>
        {% empty %}
        <p class="no-notifs">You have no notifications.</p>
        {% endfor %}
    </div>

</div>

<script>
// Real-time notification updates for this page
document.addEventListener('DOMContentLoaded', function() {
    let updateCheckInterval;
    
    // Function to add notification to page
    function addNotificationToPage(notification) {
        const notifList = document.querySelector('.notif-list');
        const noNotifsMsg = notifList.querySelector('.no-notifs');
        
        // Remove "no notifications" message if present
        if (noNotifsMsg) {
            noNotifsMsg.remove();
        }
        
        // Determine color based on notification type
        let iconColor = 'purple';
        if (notification.notification_type === 'job_post') iconColor = 'blue';
        else if (notification.notification_type === 'message') iconColor = 'green';
        else if (notification.notification_type === 'job_application') iconColor = 'orange';
        
        // Create notification element
        const notifDiv = document.createElement('div');
        notifDiv.className = 'notif-item unread';
        notifDiv.style.animation = 'slideIn 0.3s ease';
        
        notifDiv.innerHTML = `
            <div class="notif-icon ${iconColor}"></div>
            <div class="notif-content">
                <h3>${notification.title}</h3>
                <p>${notification.message}</p>
                ${notification.link ? `<a href="${notification.link}" style="color: #667eea; font-size: 13px; text-decoration: none; margin-top: 4px; display: inline-block;">View Details â†’</a>` : ''}
            </div>
            <span class="notif-type">${notification.notification_type}</span>
            <span class="notif-time">Just now</span>
            <span class="notif-status unread-badge">unread</span>
        `;
        
        // Insert at the top
        notifList.insertBefore(notifDiv, notifList.firstChild);
        
        // Highlight animation
        setTimeout(() => {
            notifDiv.style.backgroundColor = '#f0f9ff';
        }, 100);
        setTimeout(() => {
            notifDiv.style.backgroundColor = '';
        }, 2000);
    }
    
    // Connect to WebSocket when available
    function setupWebSocketListener() {
        // Check if WebSocket exists and is from base.html
        if (window.notificationSocket && window.notificationSocket.readyState === WebSocket.OPEN) {
            console.log('âœ… WebSocket found - setting up listener');
            setupListener();
            return true;
        }
        return false;
    }
    
    function setupListener() {
        // Store original handlers
        const originalHandleNotification = window.handleNotification;
        
        // Override handleNotification to also update the page
        window.handleNotification = function(notification) {
            console.log('ðŸ“Œ Adding notification to page:', notification);
            addNotificationToPage(notification);
            
            // Call original if it exists
            if (originalHandleNotification) {
                originalHandleNotification.call(this, notification);
            }
        };
    }
    
    // Try to setup immediately
    if (!setupWebSocketListener()) {
        // If WebSocket not ready, check periodically
        updateCheckInterval = setInterval(() => {
            if (setupWebSocketListener()) {
                clearInterval(updateCheckInterval);
            }
        }, 500);
        
        // Clear interval after 10 seconds
        setTimeout(() => {
            clearInterval(updateCheckInterval);
            console.log('âš ï¸ WebSocket listener setup timeout - using API polling');
            // Fallback to polling API every 5 seconds
            pollNotificationsAPI();
        }, 10000);
    }
    
    // Function to poll API for new notifications
    function pollNotificationsAPI() {
        let lastCount = document.querySelectorAll('.notif-item').length;
        
        setInterval(() => {
            fetch('/api/notifications/')
                .then(response => response.json())
                .then(data => {
                    const currentCount = document.querySelectorAll('.notif-item').length;
                    
                    // If there are new notifications, reload page
                    if (data.count > currentCount) {
                        console.log('ðŸ“¢ New notifications detected via API - reloading...');
                        location.reload();
                    }
                })
                .catch(error => console.error('API Error:', error));
        }, 5000);
    }
    
    // Mark all as read with API
    const markAllBtn = document.querySelector('.mark-read-btn');
    if (markAllBtn) {
        markAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            fetch('/api/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    document.querySelectorAll('.notif-item').forEach(item => {
                        item.classList.remove('unread');
                        const badge = item.querySelector('.notif-status');
                        if (badge) {
                            badge.className = 'notif-status read-badge';
                            badge.textContent = 'read';
                        }
                    });
                    
                    // Update badge count
                    const badges = document.querySelectorAll('.notification-badge');
                    badges.forEach(badge => badge.textContent = '0');
                    
                    console.log('âœ… All notifications marked as read');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Add slide in animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}

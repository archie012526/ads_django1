    {% extends "main/base.html" %}
    {% load static %}
    {% load custom_filters %}

    {% block extra_head %}
        <script src="https://cdn.tailwindcss.com"></script>
        <title>Responsive Job Finder</title>
    {% endblock extra_head %}

    {% block content %}

    <!-- HEADER -->
    <header class="w-full bg-white shadow-sm p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">

        <!-- Search Bar -->
        <form method="get">
            <input
                type="text"
                name="q"
                value="{{ query }}"
                placeholder="Search jobsâ€¦"
                class="w-full px-5 py-3 rounded-full border"
            />
        </form>

    </header>

    <!-- MAIN CONTENT GRID -->
    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">

        <!-- FILTERS (Desktop) -->
        <aside class="hidden lg:block bg-white p-6 rounded-2xl shadow-sm h-fit">
            <h2 class="text-xl font-bold mb-4">Filters</h2>

            <!-- Filter Group -->
            <div class="mb-6">
                <h3 class="font-semibold mb-2">Working Schedule</h3>
                <div class="space-y-2">
                    <label class="flex items-center gap-2"><input type="radio" name="work"> Full time</label>
                    <label class="flex items-center gap-2"><input type="radio" name="work"> Part-time</label>
                    <label class="flex items-center gap-2"><input type="radio" name="work"> Internship</label>
                    <label class="flex items-center gap-2"><input type="radio" name="work"> Project work</label>
                    <label class="flex items-center gap-2"><input type="radio" name="work"> Volunteering</label>
                </div>
            </div>

            <div>
                <h3 class="font-semibold mb-2">Employment Type</h3>
                <div class="space-y-2">
                    <label class="flex items-center gap-2"><input type="radio" name="emp"> Full day</label>
                    <label class="flex items-center gap-2"><input type="radio" name="emp"> Flexible schedule</label>
                    <label class="flex items-center gap-2"><input type="radio" name="emp"> Shift work</label>
                </div>
            </div>
        </aside>

        <!-- FILTERS (Mobile) -->
        <div class="lg:hidden">
            <details class="bg-white rounded-2xl shadow-sm p-4 cursor-pointer">
                <summary class="font-semibold text-lg">Filters</summary>

                <div class="mt-4 space-y-6">
                    <div>
                        <h3 class="font-semibold mb-2">Working Schedule</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2"><input type="radio" name="work"> Full time</label>
                            <label class="flex items-center gap-2"><input type="radio" name="work"> Part-time</label>
                            <label class="flex items-center gap-2"><input type="radio" name="work"> Internship</label>
                            <label class="flex items-center gap-2"><input type="radio" name="work"> Project work</label>
                            <label class="flex items-center gap-2"><input type="radio" name="work"> Volunteering</label>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold mb-2">Employment Type</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2"><input type="radio" name="emp"> Full day</label>
                            <label class="flex items-center gap-2"><input type="radio" name="emp"> Flexible schedule</label>
                            <label class="flex items-center gap-2"><input type="radio" name="emp"> Shift work</label>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- JOB LIST -->
        <section class="lg:col-span-3">

            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Popular Jobs</h1>

                <div>
                    <select class="border px-3 py-2 rounded-lg shadow text-sm">
                        <option>Date</option>
                        <option>Newest</option>
                        <option>Highest Salary</option>
                    </select>
                </div>
            </div>

            <!-- JOB CARDS -->
            <div id="jobs-list">
                {% for job in jobs %}
                <div class="bg-white p-6 rounded-2xl shadow mb-4 job-card">
                    <p class="text-xs text-gray-500 mb-2">{{ job.employer_name }}</p>

                    <h3 class="font-bold text-lg">
                        {{ job.job_title }}
                    </h3>

                    <p class="text-gray-600">
                        {{ job.job_city }}, {{ job.job_country }}
                    </p>

                    <p class="font-semibold text-lg mt-2">
                        {{ job.job_min_salary }} - {{ job.job_max_salary }}
                    </p>

                    <a href="{{ job.job_apply_link }}" target="_blank">
                        <button class="w-full bg-black text-white py-2 rounded-xl mt-4">
                            Apply
                        </button>
                    </a>
                </div>
                {% endfor %}
                {% if not jobs %}
                    <p>No jobs found.</p>
                {% endif %}
            </div>

            <script>
                // WebSocket to receive real-time popular jobs
                (function() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const socket = new WebSocket(protocol + '//' + window.location.host + '/ws/popular_jobs/');

                    socket.onmessage = function(e) {
                        try {
                            const data = JSON.parse(e.data);
                            if (data.type === 'jobs.update') {
                                renderJobs(data.jobs || []);
                            }
                        } catch (err) {
                            console.error('Invalid jobs update', err);
                        }
                    };

                    socket.onopen = function() {
                        console.log('Connected to popular_jobs websocket');
                    };

                    socket.onclose = function() {
                        console.log('popular_jobs websocket closed, will not reconnect automatically');
                    };

                    function renderJobs(jobs) {
                        const list = document.getElementById('jobs-list');
                        if (!list) return;
                        list.innerHTML = '';
                        if (!jobs || jobs.length === 0) {
                            list.innerHTML = '<p>No jobs found.</p>';
                            return;
                        }

                        jobs.forEach(job => {
                            const el = document.createElement('div');
                            el.className = 'bg-white p-6 rounded-2xl shadow mb-4 job-card';
                            el.innerHTML = `
                                <p class="text-xs text-gray-500 mb-2">${escapeHtml(job.employer_name || '')}</p>
                                <h3 class="font-bold text-lg">${escapeHtml(job.job_title || '')}</h3>
                                <p class="text-gray-600">${escapeHtml((job.job_city||'') + ', ' + (job.job_country||''))}</p>
                                <p class="font-semibold text-lg mt-2">${escapeHtml(job.job_min_salary||'')} - ${escapeHtml(job.job_max_salary||'')}</p>
                                <a href="${job.job_apply_link||'#'}" target="_blank"><button class="w-full bg-black text-white py-2 rounded-xl mt-4">Apply</button></a>
                            `;
                            list.appendChild(el);
                        });
                    }

                    function escapeHtml(s) {
                        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                    }
                })();
            </script>
        </section>
    </main>

    {% endblock content %}
